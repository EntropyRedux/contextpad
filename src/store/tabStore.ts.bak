import { create } from 'zustand'

export interface Tab {
  id: string
  title: string
  content: string
  filePath: string | null
  isDirty: boolean
  language: 'markdown' | string
  lastModifiedTime?: number
  editorView?: any // EditorView reference for outline parsing (not persisted)
}

export interface CursorInfo {
  line: number
  column: number
}

export interface ViewSettings {
  showStatusBar: boolean
  showLineNumbers: boolean
  showBreadcrumb: boolean
  fontSize: number
  fontFamily: string
  wordWrap: boolean
  theme: string
  // Performance settings
  enableBracketMatching: boolean
  enableFoldGutter: boolean
  enableAutoIndent: boolean
  largeFileThreshold: number  // Lines threshold for auto-disabling features
}

interface TabState {
  tabs: Tab[]
  activeTabId: string | null
  cursorInfo: CursorInfo | null
  viewSettings: ViewSettings
  findReplaceState: {
    showFind: boolean
    showReplace: boolean
  }
  recentFiles: string[]
  showRightSidebar: boolean
  showLeftSidebar: boolean
  openFolderPath: string | null

  addTab: (tab?: Partial<Tab>) => void
  removeTab: (id: string) => void
  setActiveTab: (id: string) => void
  updateTab: (id: string, updates: Partial<Tab>) => void
  getActiveTab: () => Tab | null
  setCursorInfo: (info: CursorInfo | null) => void
  setViewSettings: (settings: Partial<ViewSettings>) => void
  reorderTabs: (fromIndex: number, toIndex: number) => void
  openFind: () => void
  openReplace: () => void
  closeFindReplace: () => void
  addRecentFile: (filePath: string) => void
  toggleRightSidebar: () => void
  toggleLeftSidebar: () => void
  setOpenFolderPath: (path: string | null) => void
}

// Load persisted state from localStorage
const loadPersistedState = () => {
  try {
    const savedState = localStorage.getItem('contextpad-tabs')
    if (savedState) {
      const parsed = JSON.parse(savedState)
      const defaultViewSettings = {
        showStatusBar: true,
        showLineNumbers: true,
        showBreadcrumb: true,
        fontSize: 14,
        fontFamily: 'Consolas',
        wordWrap: true,
        theme: 'one-dark',
        // Performance settings defaults
        enableBracketMatching: true,
        enableFoldGutter: true,
        enableAutoIndent: true,
        largeFileThreshold: 5000,  // Auto-disable features at 5000 lines
      }
      return {
        tabs: parsed.tabs || [],
        activeTabId: parsed.activeTabId || null,
        // Merge saved settings with defaults to handle new properties
        viewSettings: { ...defaultViewSettings, ...parsed.viewSettings },
        recentFiles: parsed.recentFiles || []
      }
    }
  } catch (error) {
    console.error('Failed to load persisted state:', error)
  }
  return null
}

// Save state to localStorage
const persistState = (state: TabState) => {
  try {
    // Exclude editorView from tabs when persisting
    // PERFORMANCE FIX: Limit content size to prevent localStorage quota errors
    const tabsWithoutEditorView = state.tabs.map(({ editorView, content, ...tab }) => ({
      ...tab,
      // Only store first 50k characters to prevent quota errors (emergency fix)
      // TODO: Remove content entirely and load from files on demand
      content: content.slice(0, 50000)
    }))
    const stateToPersist = {
      tabs: tabsWithoutEditorView,
      activeTabId: state.activeTabId,
      viewSettings: state.viewSettings,
      recentFiles: state.recentFiles
    }
    localStorage.setItem('contextpad-tabs', JSON.stringify(stateToPersist))
  } catch (error) {
    console.error('Failed to persist state:', error)

    // CRITICAL: If quota exceeded, try clearing and saving minimal state
    if (error instanceof Error && error.name === 'QuotaExceededError') {
      console.warn('LocalStorage quota exceeded, clearing old data')
      try {
        localStorage.removeItem('contextpad-tabs')
        // Save only essential state
        localStorage.setItem('contextpad-tabs', JSON.stringify({
          tabs: state.tabs.map(({ id, title, filePath, language, isDirty }) => ({
            id, title, filePath, language, isDirty, content: ''
          })),
          activeTabId: state.activeTabId,
          viewSettings: state.viewSettings,
          recentFiles: state.recentFiles.slice(0, 5)
        }))
      } catch (fallbackError) {
        console.error('CRITICAL: Cannot persist state even after clearing', fallbackError)
      }
    }
  }
}

const persistedState = loadPersistedState()

export const useTabStore = create<TabState>((set, get) => ({
  tabs: persistedState?.tabs || [],
  activeTabId: persistedState?.activeTabId || null,
  cursorInfo: null,
  viewSettings: persistedState?.viewSettings || {
    showStatusBar: true,
    showLineNumbers: true,
    showBreadcrumb: true,
    fontSize: 14,
    fontFamily: 'Consolas',
    wordWrap: true,
    theme: 'one-dark',
    enableBracketMatching: true,
    enableFoldGutter: true,
    enableAutoIndent: true,
    largeFileThreshold: 5000,
  },
  findReplaceState: {
    showFind: false,
    showReplace: false,
  },
  recentFiles: persistedState?.recentFiles || [],
  showRightSidebar: false,
  showLeftSidebar: false,
  openFolderPath: null,

  addTab: (tab) => {
    const newTab: Tab = {
      id: crypto.randomUUID(),
      title: tab?.title || 'Untitled',
      content: tab?.content || '',
      filePath: tab?.filePath || null,
      isDirty: false,
      language: tab?.language || 'markdown',
      ...tab
    }

    set((state) => {
      const newState = {
        ...state,
        tabs: [...state.tabs, newTab],
        activeTabId: newTab.id
      }
      persistState(newState)
      return { tabs: newState.tabs, activeTabId: newState.activeTabId }
    })
  },

  removeTab: (id) => {
    set((state) => {
      const tabs = state.tabs.filter(t => t.id !== id)
      const activeTabId = state.activeTabId === id
        ? (tabs[0]?.id || null)
        : state.activeTabId
      const newState = { ...state, tabs, activeTabId }
      persistState(newState)
      return { tabs, activeTabId }
    })
  },

  setActiveTab: (id) => {
    set((state) => {
      const newState = { ...state, activeTabId: id }
      persistState(newState)
      return { activeTabId: id }
    })
  },

  updateTab: (id, updates) => {
    set((state) => {
      const tabs = state.tabs.map(t =>
        t.id === id ? { ...t, ...updates } : t
      )
      const newState = { ...state, tabs }
      persistState(newState)
      return { tabs }
    })
  },

  getActiveTab: () => {
    const { tabs, activeTabId } = get()
    return tabs.find(t => t.id === activeTabId) || null
  },

  setCursorInfo: (info) => set({ cursorInfo: info }),

  setViewSettings: (settings) => {
    set((state) => {
      const viewSettings = { ...state.viewSettings, ...settings }
      const newState = { ...state, viewSettings }
      persistState(newState)
      return { viewSettings }
    })
  },

  reorderTabs: (fromIndex, toIndex) => {
    set((state) => {
      const newTabs = [...state.tabs]
      const [movedTab] = newTabs.splice(fromIndex, 1)
      newTabs.splice(toIndex, 0, movedTab)
      const newState = { ...state, tabs: newTabs }
      persistState(newState)
      return { tabs: newTabs }
    })
  },

  openFind: () => {
    set({
      findReplaceState: {
        showFind: true,
        showReplace: false,
      }
    })
  },

  openReplace: () => {
    set({
      findReplaceState: {
        showFind: true,
        showReplace: true,
      }
    })
  },

  closeFindReplace: () => {
    set({
      findReplaceState: {
        showFind: false,
        showReplace: false,
      }
    })
  },

  addRecentFile: (filePath) => {
    set((state) => {
      // Remove if already exists, then add to front
      const filtered = state.recentFiles.filter(f => f !== filePath)
      const recentFiles = [filePath, ...filtered].slice(0, 10) // Keep max 10
      const newState = { ...state, recentFiles }
      persistState(newState)
      return { recentFiles }
    })
  },

  toggleRightSidebar: () => {
    set((state) => ({
      showRightSidebar: !state.showRightSidebar
    }))
  },

  toggleLeftSidebar: () => {
    set((state) => ({
      showLeftSidebar: !state.showLeftSidebar
    }))
  },

  setOpenFolderPath: (path) => {
    set({ openFolderPath: path })
  }
}))
